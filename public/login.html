<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login · Codex Chat</title>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --line:#ddd; --btn:#111; --btnfg:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif; }
    main { max-width:420px; margin:64px auto; padding:16px; display:grid; gap:10px; }
    h1 { margin:0; font-size:18px; }
    label { display:grid; gap:4px; color:var(--muted); font-size:12px; }
    input, button { font:inherit; color:var(--fg); border:1px solid var(--line); border-radius:6px; padding:8px; background:#fff; }
    button { background:var(--btn); border-color:var(--btn); color:var(--btnfg); cursor:pointer; }
    .status { min-height:18px; color:var(--muted); font-size:12px; }
    .version { color:var(--muted); font-size:11px; line-height:1.3; }
  </style>
</head>
<body>
  <main>
    <h1>Login</h1>
    <label>
      Username
      <input id="username" type="text" autocomplete="username">
    </label>
    <label>
      Password
      <input id="password" type="password" autocomplete="current-password">
    </label>
    <button id="login" type="button">Sign In</button>
    <div class="status" id="status"></div>
    <div class="version" id="version"></div>
  </main>

  <script>
    const el = {
      username: document.getElementById("username"),
      password: document.getElementById("password"),
      login: document.getElementById("login"),
      status: document.getElementById("status"),
      version: document.getElementById("version")
    };

    function setStatus(text) {
      el.status.textContent = text || "";
    }

    async function doLogin() {
      const username = el.username.value.trim();
      const password = el.password.value;
      if (!username || !password) {
        setStatus("Username and password are required");
        return;
      }

      el.login.disabled = true;
      setStatus("Signing in...");
      try {
        const res = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Login failed");
        window.location.href = "/";
      } catch (err) {
        setStatus(err.message || String(err));
      } finally {
        el.login.disabled = false;
      }
    }

    el.login.addEventListener("click", doLogin);
    el.password.addEventListener("keydown", (event) => {
      if (event.key === "Enter") doLogin();
    });

    (async () => {
      try {
        const res = await fetch("/api/version", { cache: "no-store" });
        if (!res.ok) return;
        const v = await res.json().catch(() => null);
        if (!v) return;
        const version = typeof v.version === "string" ? v.version : "";
        const sha = v.git && typeof v.git.sha === "string" ? v.git.sha : "";
        const dirty = v.git && v.git.dirty ? "*" : "";
        const build = v.build && typeof v.build.id === "string" ? v.build.id : "";
        el.version.textContent = [
          version && `v${version}`,
          (sha ? `${sha}${dirty}` : (build ? `build ${build}` : "")),
        ].filter(Boolean).join(" · ");
      } catch {
        // ignore
      }
    })();
  </script>
</body>
</html>
